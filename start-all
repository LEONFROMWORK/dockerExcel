#!/bin/bash

# Excel Unified ì „ì²´ ì‹œìŠ¤í…œ ì›í´ë¦­ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
# ëª¨ë“  ì„œë²„ì™€ Docker ì„œë¹„ìŠ¤ë¥¼ í•œ ë²ˆì— ì‹œì‘

set -e  # Exit on any error

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ë¡œê·¸ í•¨ìˆ˜ë“¤
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

log_header() {
    echo -e "${BOLD}${CYAN}ğŸš€ $1${NC}"
}

# íŒŒë¼ë¯¸í„° íŒŒì‹±
ONLY_SERVICE=""
OPEN_BROWSER=true
VERBOSE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --only)
            ONLY_SERVICE="$2"
            shift 2
            ;;
        --no-browser)
            OPEN_BROWSER=false
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help)
            echo "ì‚¬ìš©ë²•: ./start-all [ì˜µì…˜]"
            echo "ì˜µì…˜:"
            echo "  --only [rails|python|collabora|docker]  íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ì‹¤í–‰"
            echo "  --no-browser                             ë¸Œë¼ìš°ì € ìë™ ì‹¤í–‰ ì•ˆí•¨"
            echo "  --verbose                                ìì„¸í•œ ë¡œê·¸ ì¶œë ¥"
            echo "  --help                                   ë„ì›€ë§ í‘œì‹œ"
            exit 0
            ;;
        *)
            log_error "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
            exit 1
            ;;
    esac
done

# ì‹œì‘ ì‹œê°„ ê¸°ë¡
START_TIME=$(date +%s)

log_header "Excel Unified í†µí•© ì‹œìŠ¤í…œ ì‹œì‘"
echo ""

# 1. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
if [[ -z "$ONLY_SERVICE" || "$ONLY_SERVICE" == "all" ]]; then
    log_info "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."

    # Rails ì„œë²„ ì¢…ë£Œ
    pkill -f "rails server" 2>/dev/null || true
    pkill -f "puma" 2>/dev/null || true

    # Vite ê°œë°œ ì„œë²„ ì¢…ë£Œ
    pkill -f "vite" 2>/dev/null || true
    pkill -f "node.*vite" 2>/dev/null || true

    # Python ì„œë¹„ìŠ¤ ì¢…ë£Œ
    pkill -f "uvicorn" 2>/dev/null || true
    pkill -f "python.*main:app" 2>/dev/null || true

    # Sidekiq ì¢…ë£Œ
    pkill -f "sidekiq" 2>/dev/null || true

    # tmux ì„¸ì…˜ ì¢…ë£Œ
    tmux kill-session -t excel-unified 2>/dev/null || true

    sleep 2
    log_success "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì™„ë£Œ"
fi

# 2. í•„ìˆ˜ ì„œë¹„ìŠ¤ í™•ì¸ í•¨ìˆ˜
check_postgresql() {
    log_info "PostgreSQL ìƒíƒœ í™•ì¸ ì¤‘..."
    if pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
        log_success "PostgreSQL ì‹¤í–‰ ì¤‘"
        return 0
    else
        log_warning "PostgreSQLì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        log_info "PostgreSQL ì‹œì‘ ì‹œë„ ì¤‘..."

        # macOSì—ì„œ PostgreSQL ì‹œì‘ ì‹œë„
        if command -v brew &> /dev/null; then
            brew services start postgresql@14 2>/dev/null || brew services start postgresql 2>/dev/null || true
            sleep 3
            if pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
                log_success "PostgreSQL ì‹œì‘ë¨"
                return 0
            fi
        fi

        log_error "PostgreSQLì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì£¼ì„¸ìš”:"
        log_error "  brew services start postgresql"
        return 1
    fi
}

check_redis() {
    log_info "Redis ìƒíƒœ í™•ì¸ ì¤‘..."
    if redis-cli ping > /dev/null 2>&1; then
        log_success "Redis ì‹¤í–‰ ì¤‘"
        return 0
    else
        log_warning "Redisê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        log_info "Redis ì‹œì‘ ì‹œë„ ì¤‘..."

        # macOSì—ì„œ Redis ì‹œì‘ ì‹œë„
        if command -v brew &> /dev/null; then
            brew services start redis 2>/dev/null || true
            sleep 2
            if redis-cli ping > /dev/null 2>&1; then
                log_success "Redis ì‹œì‘ë¨"
                return 0
            fi
        fi

        log_error "Redisë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì£¼ì„¸ìš”:"
        log_error "  brew services start redis"
        return 1
    fi
}

# 3. Docker ì„œë¹„ìŠ¤ ì‹œì‘ í•¨ìˆ˜
start_collabora_docker() {
    log_info "Collabora Online Docker ìƒíƒœ í™•ì¸ ì¤‘..."

    # ê¸°ì¡´ Collabora ì»¨í…Œì´ë„ˆ í™•ì¸
    EXISTING_CONTAINER=$(docker ps -a --filter "name=collabora" --format "{{.Names}}" | head -1)

    if [[ -n "$EXISTING_CONTAINER" ]]; then
        CONTAINER_STATUS=$(docker inspect --format="{{.State.Status}}" "$EXISTING_CONTAINER")

        if [[ "$CONTAINER_STATUS" == "running" ]]; then
            log_success "Collabora Docker ì´ë¯¸ ì‹¤í–‰ ì¤‘: $EXISTING_CONTAINER"
            return 0
        else
            log_info "ê¸°ì¡´ Collabora ì»¨í…Œì´ë„ˆ ì‹œì‘: $EXISTING_CONTAINER"
            docker start "$EXISTING_CONTAINER"
            sleep 5
            log_success "Collabora Docker ì‹œì‘ë¨"
            return 0
        fi
    fi

    # ìƒˆ Collabora ì»¨í…Œì´ë„ˆ ì‹¤í–‰
    log_info "ìƒˆ Collabora Online ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
    docker run -d \
        --name collabora-unified \
        -p 9980:9980 \
        -e "aliasgroup1=http://host.docker.internal:3000" \
        -e "extra_params=--o:ssl.enable=false --o:ssl.termination=true" \
        -e "DONT_GEN_SSL_CERT=1" \
        --add-host host.docker.internal:host-gateway \
        collabora/code:23.05.4.2.1

    # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
    log_info "Collabora ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
    for i in {1..30}; do
        if curl -s "http://localhost:9980/hosting/discovery" > /dev/null 2>&1; then
            log_success "Collabora Online ì‹¤í–‰ë¨ (í¬íŠ¸ 9980)"
            return 0
        fi
        sleep 2
    done

    log_error "Collabora Online ì‹œì‘ ì‹¤íŒ¨"
    return 1
}

# 4. ì„œë¹„ìŠ¤ë³„ ì‹œì‘ í•¨ìˆ˜ë“¤
start_rails() {
    log_info "Rails ì„œë²„ ì‹œì‘ ì¤‘... (í¬íŠ¸ 3000)"
    cd /Users/kevin/excel-unified/rails-app

    # í™˜ê²½ ì„¤ì •
    export RAILS_ENV=development
    export PORT=3000

    # tmux ì„¸ì…˜ ìƒì„± ë° Rails ì‹œì‘
    tmux new-session -d -s excel-unified -n rails
    tmux send-keys -t excel-unified:rails "cd /Users/kevin/excel-unified/rails-app && bin/dev" C-m

    # Rails ì„œë²„ ì‹œì‘ ëŒ€ê¸°
    log_info "Rails ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
    for i in {1..30}; do
        if curl -s "http://localhost:3000/up" > /dev/null 2>&1; then
            log_success "Rails ì„œë²„ ì‹¤í–‰ë¨ (í¬íŠ¸ 3000)"
            return 0
        fi
        sleep 2
    done

    log_error "Rails ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
    return 1
}

start_python() {
    log_info "Python ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘... (í¬íŠ¸ 8000)"

    # í¬íŠ¸ 8000ì´ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸
    if lsof -ti:8000 > /dev/null 2>&1; then
        log_warning "í¬íŠ¸ 8000ì´ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
        kill -9 $(lsof -ti:8000) 2>/dev/null || true
        sleep 2
    fi

    # Python ì„œë¹„ìŠ¤ë¥¼ ë³„ë„ tmux ìœˆë„ìš°ì—ì„œ ì‹¤í–‰
    tmux new-window -t excel-unified -n python
    tmux send-keys -t excel-unified:python "cd /Users/kevin/excel-unified/python-service && ./start_service.sh" C-m

    # Python ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° (ì‹œê°„ ì¦ê°€ ë° ë” ìì„¸í•œ ì²´í¬)
    log_info "Python ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
    for i in {1..45}; do
        if curl -s "http://localhost:8000/health" > /dev/null 2>&1; then
            log_success "Python ì„œë¹„ìŠ¤ ì‹¤í–‰ë¨ (í¬íŠ¸ 8000)"
            # ì¶”ê°€ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            if curl -s "http://localhost:8000/docs" > /dev/null 2>&1; then
                log_success "Python API ë¬¸ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤"
            fi
            return 0
        fi

        # ì§„í–‰ ìƒí™© í‘œì‹œ
        if [[ $((i % 5)) -eq 0 ]]; then
            log_info "Python ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘... (${i}/45)"
        fi
        sleep 2
    done

    log_error "Python ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
    log_error "tmux attach -t excel-unified:python ìœ¼ë¡œ ë¡œê·¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”"
    return 1
}

start_sidekiq() {
    log_info "Sidekiq ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‹œì‘ ì¤‘..."

    # Sidekiqì„ ë³„ë„ tmux ìœˆë„ìš°ì—ì„œ ì‹¤í–‰
    tmux new-window -t excel-unified -n sidekiq
    tmux send-keys -t excel-unified:sidekiq "cd /Users/kevin/excel-unified/rails-app && bundle exec sidekiq" C-m

    sleep 3
    log_success "Sidekiq ì‹¤í–‰ë¨"
}

# 5. ìƒíƒœ í™•ì¸ í•¨ìˆ˜
check_all_services() {
    log_info "ëª¨ë“  ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."

    SERVICES_STATUS=""

    # Rails ìƒíƒœ í™•ì¸
    if curl -s "http://localhost:3000/up" > /dev/null 2>&1; then
        SERVICES_STATUS+="${GREEN}âœ… Rails (3000)${NC}\n"
    else
        SERVICES_STATUS+="${RED}âŒ Rails (3000)${NC}\n"
    fi

    # Python ìƒíƒœ í™•ì¸
    if curl -s "http://localhost:8000/health" > /dev/null 2>&1; then
        SERVICES_STATUS+="${GREEN}âœ… Python (8000)${NC}\n"
    else
        SERVICES_STATUS+="${RED}âŒ Python (8000)${NC}\n"
    fi

    # Collabora ìƒíƒœ í™•ì¸
    if curl -s "http://localhost:9980/hosting/discovery" > /dev/null 2>&1; then
        SERVICES_STATUS+="${GREEN}âœ… Collabora (9980)${NC}\n"
    else
        SERVICES_STATUS+="${RED}âŒ Collabora (9980)${NC}\n"
    fi

    # PostgreSQL ìƒíƒœ í™•ì¸
    if pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
        SERVICES_STATUS+="${GREEN}âœ… PostgreSQL (5432)${NC}\n"
    else
        SERVICES_STATUS+="${RED}âŒ PostgreSQL (5432)${NC}\n"
    fi

    # Redis ìƒíƒœ í™•ì¸
    if redis-cli ping > /dev/null 2>&1; then
        SERVICES_STATUS+="${GREEN}âœ… Redis (6379)${NC}\n"
    else
        SERVICES_STATUS+="${RED}âŒ Redis (6379)${NC}\n"
    fi

    echo -e "$SERVICES_STATUS"
}

# 6. ë©”ì¸ ì‹¤í–‰ ë¡œì§
main() {
    case "$ONLY_SERVICE" in
        "rails")
            check_postgresql || exit 1
            check_redis || exit 1
            start_rails || exit 1
            ;;
        "python")
            start_python || exit 1
            ;;
        "collabora")
            start_collabora_docker || exit 1
            ;;
        "docker")
            start_collabora_docker || exit 1
            ;;
        *)
            # ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘
            log_header "í•„ìˆ˜ ì„œë¹„ìŠ¤ í™•ì¸"
            check_postgresql || exit 1
            check_redis || exit 1

            log_header "Docker ì„œë¹„ìŠ¤ ì‹œì‘"
            start_collabora_docker || exit 1

            log_header "ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ ì‹œì‘"
            start_rails || exit 1
            start_python || exit 1
            start_sidekiq || exit 1
            ;;
    esac

    # ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))

    echo ""
    log_header "ğŸ‰ Excel Unified ì‹œìŠ¤í…œ ì‹œì‘ ì™„ë£Œ! (${DURATION}ì´ˆ)"
    echo ""

    # ì„œë¹„ìŠ¤ ìƒíƒœ í‘œì‹œ
    check_all_services

    echo ""
    log_info "ì„œë¹„ìŠ¤ URL:"
    echo -e "  ${CYAN}ğŸ“ ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜: ${BOLD}http://localhost:3000${NC}"
    echo -e "  ${CYAN}ğŸ“ Python API: ${BOLD}http://localhost:8000${NC}"
    echo -e "  ${CYAN}ğŸ“ API ë¬¸ì„œ: ${BOLD}http://localhost:8000/docs${NC}"
    echo -e "  ${CYAN}ğŸ“ Collabora Online: ${BOLD}http://localhost:9980${NC}"
    echo ""

    log_info "ìœ ìš©í•œ ëª…ë ¹ì–´:"
    echo -e "  ${YELLOW}tmux attach -t excel-unified${NC}    # ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
    echo -e "  ${YELLOW}./stop-all${NC}                     # ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ"
    echo -e "  ${YELLOW}docker logs -f collabora-unified${NC} # Collabora ë¡œê·¸ í™•ì¸"
    echo ""

    # ë¸Œë¼ìš°ì € ìë™ ì‹¤í–‰
    if [[ "$OPEN_BROWSER" == true && -z "$ONLY_SERVICE" ]]; then
        log_info "ë¸Œë¼ìš°ì €ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—´ê¸° ì¤‘..."
        if command -v open &> /dev/null; then
            # macOS
            open "http://localhost:3000"
        elif command -v xdg-open &> /dev/null; then
            # Linux
            xdg-open "http://localhost:3000"
        fi
    fi
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"
