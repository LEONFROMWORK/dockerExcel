#!/bin/bash

# Excel Unified ì „ì²´ ì‹œìŠ¤í…œ ì¢…ë£Œ ìŠ¤í¬ë¦½íŠ¸
# ëª¨ë“  ì„œë²„ì™€ Docker ì„œë¹„ìŠ¤ë¥¼ ì •ë¦¬

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ë¡œê·¸ í•¨ìˆ˜ë“¤
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

log_header() {
    echo -e "${BOLD}${CYAN}ğŸ›‘ $1${NC}"
}

# íŒŒë¼ë¯¸í„° íŒŒì‹±
FORCE=false
KEEP_DOCKER=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE=true
            shift
            ;;
        --keep-docker)
            KEEP_DOCKER=true
            shift
            ;;
        --help)
            echo "ì‚¬ìš©ë²•: ./stop-all [ì˜µì…˜]"
            echo "ì˜µì…˜:"
            echo "  --force        ê°•ì œ ì¢…ë£Œ (SIGKILL ì‚¬ìš©)"
            echo "  --keep-docker  Docker ì»¨í…Œì´ë„ˆ ìœ ì§€"
            echo "  --help         ë„ì›€ë§ í‘œì‹œ"
            exit 0
            ;;
        *)
            log_error "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
            exit 1
            ;;
    esac
done

log_header "Excel Unified ì‹œìŠ¤í…œ ì¢…ë£Œ"
echo ""

# 1. tmux ì„¸ì…˜ ì¢…ë£Œ
log_info "tmux ì„¸ì…˜ ì¢…ë£Œ ì¤‘..."
if tmux has-session -t excel-unified 2>/dev/null; then
    tmux kill-session -t excel-unified
    log_success "tmux ì„¸ì…˜ 'excel-unified' ì¢…ë£Œë¨"
else
    log_info "tmux ì„¸ì…˜ 'excel-unified'ê°€ ì‹¤í–‰ ì¤‘ì´ì§€ ì•ŠìŒ"
fi

# 2. Rails ì„œë²„ ì¢…ë£Œ
log_info "Rails ì„œë²„ ì¢…ë£Œ ì¤‘..."
if [[ "$FORCE" == true ]]; then
    pkill -9 -f "rails server" 2>/dev/null || true
    pkill -9 -f "puma" 2>/dev/null || true
else
    pkill -TERM -f "rails server" 2>/dev/null || true
    pkill -TERM -f "puma" 2>/dev/null || true
fi
log_success "Rails ì„œë²„ ì¢…ë£Œë¨"

# 3. Vite ê°œë°œ ì„œë²„ ì¢…ë£Œ
log_info "Vite ê°œë°œ ì„œë²„ ì¢…ë£Œ ì¤‘..."
if [[ "$FORCE" == true ]]; then
    pkill -9 -f "vite" 2>/dev/null || true
    pkill -9 -f "node.*vite" 2>/dev/null || true
else
    pkill -TERM -f "vite" 2>/dev/null || true
    pkill -TERM -f "node.*vite" 2>/dev/null || true
fi
log_success "Vite ê°œë°œ ì„œë²„ ì¢…ë£Œë¨"

# 4. Python ì„œë¹„ìŠ¤ ì¢…ë£Œ
log_info "Python ì„œë¹„ìŠ¤ ì¢…ë£Œ ì¤‘..."
if [[ "$FORCE" == true ]]; then
    pkill -9 -f "uvicorn" 2>/dev/null || true
    pkill -9 -f "python.*main:app" 2>/dev/null || true
else
    pkill -TERM -f "uvicorn" 2>/dev/null || true
    pkill -TERM -f "python.*main:app" 2>/dev/null || true
fi
log_success "Python ì„œë¹„ìŠ¤ ì¢…ë£Œë¨"

# 5. Sidekiq ì¢…ë£Œ
log_info "Sidekiq ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì¢…ë£Œ ì¤‘..."
if [[ "$FORCE" == true ]]; then
    pkill -9 -f "sidekiq" 2>/dev/null || true
else
    pkill -TERM -f "sidekiq" 2>/dev/null || true
fi
log_success "Sidekiq ì¢…ë£Œë¨"

# 6. Tailwind CSS í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
log_info "Tailwind CSS í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘..."
if [[ "$FORCE" == true ]]; then
    pkill -9 -f "tailwindcss" 2>/dev/null || true
else
    pkill -TERM -f "tailwindcss" 2>/dev/null || true
fi
log_success "Tailwind CSS í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œë¨"

# 7. Docker ì»¨í…Œì´ë„ˆ ì¢…ë£Œ (ì˜µì…˜)
if [[ "$KEEP_DOCKER" == false ]]; then
    log_info "Collabora Docker ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ì¤‘..."

    # Collabora ê´€ë ¨ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
    COLLABORA_CONTAINERS=$(docker ps -a --filter "name=collabora" --format "{{.Names}}")

    if [[ -n "$COLLABORA_CONTAINERS" ]]; then
        echo "$COLLABORA_CONTAINERS" | while read -r container; do
            log_info "ì»¨í…Œì´ë„ˆ ì¢…ë£Œ: $container"
            docker stop "$container" 2>/dev/null || true
            if [[ "$FORCE" == true ]]; then
                docker rm "$container" 2>/dev/null || true
                log_success "ì»¨í…Œì´ë„ˆ ì‚­ì œ: $container"
            else
                log_success "ì»¨í…Œì´ë„ˆ ì¤‘ì§€: $container"
            fi
        done
    else
        log_info "ì‹¤í–‰ ì¤‘ì¸ Collabora ì»¨í…Œì´ë„ˆê°€ ì—†ìŒ"
    fi
else
    log_info "Docker ì»¨í…Œì´ë„ˆ ìœ ì§€ (--keep-docker ì˜µì…˜)"
fi

# 8. í¬íŠ¸ ì‚¬ìš© í™•ì¸ ë° ì •ë¦¬
log_info "í¬íŠ¸ ì‚¬ìš© ìƒíƒœ í™•ì¸ ì¤‘..."

check_port() {
    local port=$1
    local service=$2
    if lsof -ti:$port > /dev/null 2>&1; then
        local pid=$(lsof -ti:$port)
        log_warning "$service (í¬íŠ¸ $port)ê°€ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ (PID: $pid)"
        if [[ "$FORCE" == true ]]; then
            kill -9 $pid 2>/dev/null || true
            log_success "$service ê°•ì œ ì¢…ë£Œë¨"
        fi
    fi
}

check_port 3000 "Rails"
check_port 8000 "Python"
check_port 5173 "Vite"
check_port 9980 "Collabora"

# 9. ì„ì‹œ íŒŒì¼ ì •ë¦¬
log_info "ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."

# Rails PID íŒŒì¼ ì •ë¦¬
rm -f /Users/kevin/excel-unified/rails-app/tmp/pids/server.pid 2>/dev/null || true

# Python ìºì‹œ ì •ë¦¬
find /Users/kevin/excel-unified/python-service -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
find /Users/kevin/excel-unified/python-service -name "*.pyc" -delete 2>/dev/null || true

log_success "ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"

# 10. í”„ë¡œì„¸ìŠ¤ ëŒ€ê¸°
if [[ "$FORCE" == false ]]; then
    log_info "í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ëŒ€ê¸° ì¤‘..."
    sleep 3
fi

echo ""
log_header "ğŸ‰ Excel Unified ì‹œìŠ¤í…œ ì¢…ë£Œ ì™„ë£Œ!"
echo ""

# ì¢…ë£Œ ìƒíƒœ í™•ì¸
log_info "ì¢…ë£Œ ìƒíƒœ í™•ì¸:"

PORTS_STATUS=""

check_port_status() {
    local port=$1
    local service=$2
    if lsof -ti:$port > /dev/null 2>&1; then
        PORTS_STATUS+="${RED}âŒ $service (í¬íŠ¸ $port ì‚¬ìš© ì¤‘)${NC}\n"
    else
        PORTS_STATUS+="${GREEN}âœ… $service (í¬íŠ¸ $port í•´ì œë¨)${NC}\n"
    fi
}

check_port_status 3000 "Rails"
check_port_status 8000 "Python"
check_port_status 5173 "Vite"
check_port_status 9980 "Collabora"

echo -e "$PORTS_STATUS"

# Docker ìƒíƒœ í™•ì¸
if [[ "$KEEP_DOCKER" == false ]]; then
    RUNNING_COLLABORA=$(docker ps --filter "name=collabora" --format "{{.Names}}")
    if [[ -z "$RUNNING_COLLABORA" ]]; then
        echo -e "${GREEN}âœ… Collabora Docker ì»¨í…Œì´ë„ˆ ì¢…ë£Œë¨${NC}"
    else
        echo -e "${RED}âŒ Collabora Docker ì»¨í…Œì´ë„ˆ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘: $RUNNING_COLLABORA${NC}"
    fi
fi

echo ""
log_info "ì‹œìŠ¤í…œì„ ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´:"
echo -e "  ${CYAN}./start-all${NC}"
echo ""

if [[ "$FORCE" == true ]]; then
    log_warning "ê°•ì œ ì¢…ë£Œê°€ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„° ì†ì‹¤ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
fi
