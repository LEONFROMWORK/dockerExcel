#!/bin/bash

# Excel Unified ê°œì„ ëœ í†µí•© ì‹œìŠ¤í…œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
# ë³‘ë ¬ ì²˜ë¦¬ì™€ í–¥ìƒëœ ì—ëŸ¬ ì²˜ë¦¬ë¡œ ë¹ ë¥¸ ì‹œì‘

set -e  # Exit on any error

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ë¡œê·¸ í•¨ìˆ˜ë“¤
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

log_header() {
    echo -e "${BOLD}${CYAN}ğŸš€ $1${NC}"
}

# ì§„í–‰ í‘œì‹œê¸°
show_progress() {
    local task=$1
    local current=$2
    local total=$3
    local percent=$((current * 100 / total))
    printf "\r${BLUE}[%-50s] %d%% - %s${NC}" "$(printf '#%.0s' $(seq 1 $((percent/2))))" "$percent" "$task"
    if [ "$current" -eq "$total" ]; then
        echo ""
    fi
}

# íŒŒë¼ë¯¸í„° íŒŒì‹±
ONLY_SERVICE=""
OPEN_BROWSER=true
VERBOSE=false
PARALLEL=true
SKIP_CHECKS=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --only)
            ONLY_SERVICE="$2"
            shift 2
            ;;
        --no-browser)
            OPEN_BROWSER=false
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --no-parallel)
            PARALLEL=false
            shift
            ;;
        --skip-checks)
            SKIP_CHECKS=true
            shift
            ;;
        --help)
            echo "ì‚¬ìš©ë²•: ./start-all-improved [ì˜µì…˜]"
            echo "ì˜µì…˜:"
            echo "  --only [rails|python|collabora|docker]  íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ì‹¤í–‰"
            echo "  --no-browser                             ë¸Œë¼ìš°ì € ìë™ ì‹¤í–‰ ì•ˆí•¨"
            echo "  --verbose                                ìì„¸í•œ ë¡œê·¸ ì¶œë ¥"
            echo "  --no-parallel                            ìˆœì°¨ì  ì‹¤í–‰ (ë””ë²„ê¹…ìš©)"
            echo "  --skip-checks                            ì„œë¹„ìŠ¤ ê²€ì¦ ê±´ë„ˆë›°ê¸°"
            echo "  --help                                   ë„ì›€ë§ í‘œì‹œ"
            exit 0
            ;;
        *)
            log_error "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
            exit 1
            ;;
    esac
done

# ì‹œì‘ ì‹œê°„ ê¸°ë¡
START_TIME=$(date +%s)

# PID ì €ì¥ìš© ë°°ì—´
declare -a SERVICE_PIDS

# í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ í•¨ìˆ˜
cleanup_processes() {
    log_info "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."

    # tmux ì„¸ì…˜ ì¢…ë£Œ
    tmux kill-session -t excel-unified 2>/dev/null || true

    # í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ëª©ë¡
    local processes=(
        "rails server"
        "puma"
        "vite"
        "node.*vite"
        "uvicorn"
        "python.*main:app"
        "sidekiq"
        "tailwindcss"
    )

    for proc in "${processes[@]}"; do
        pkill -f "$proc" 2>/dev/null || true
    done

    # í¬íŠ¸ê°€ í•´ì œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    sleep 2

    # í¬íŠ¸ ê°•ì œ í•´ì œ
    for port in 3000 8000 5173; do
        if lsof -ti:$port > /dev/null 2>&1; then
            kill -9 $(lsof -ti:$port) 2>/dev/null || true
        fi
    done

    log_success "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì™„ë£Œ"
}

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
check_service_health() {
    local service=$1
    local url=$2
    local max_attempts=${3:-30}
    local wait_time=${4:-2}

    for i in $(seq 1 $max_attempts); do
        if curl -s "$url" > /dev/null 2>&1; then
            return 0
        fi
        sleep $wait_time
        if [[ $((i % 5)) -eq 0 ]] && [[ "$VERBOSE" == true ]]; then
            log_info "$service ëŒ€ê¸° ì¤‘... ($i/$max_attempts)"
        fi
    done
    return 1
}

# PostgreSQL ì‹œì‘ í•¨ìˆ˜
ensure_postgresql() {
    if [[ "$SKIP_CHECKS" == true ]]; then
        return 0
    fi

    log_info "PostgreSQL ìƒíƒœ í™•ì¸ ì¤‘..."
    if ! pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
        log_warning "PostgreSQLì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        if command -v brew &> /dev/null; then
            brew services start postgresql@14 2>/dev/null || brew services start postgresql 2>/dev/null || true
            sleep 3
        fi

        if ! pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
            log_error "PostgreSQLì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            return 1
        fi
    fi
    log_success "PostgreSQL ì‹¤í–‰ ì¤‘"
    return 0
}

# Redis ì‹œì‘ í•¨ìˆ˜
ensure_redis() {
    if [[ "$SKIP_CHECKS" == true ]]; then
        return 0
    fi

    log_info "Redis ìƒíƒœ í™•ì¸ ì¤‘..."
    if ! redis-cli ping > /dev/null 2>&1; then
        log_warning "Redisê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        if command -v brew &> /dev/null; then
            brew services start redis 2>/dev/null || true
            sleep 2
        fi

        if ! redis-cli ping > /dev/null 2>&1; then
            log_error "Redisë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            return 1
        fi
    fi
    log_success "Redis ì‹¤í–‰ ì¤‘"
    return 0
}

# Docker Collabora ì‹œì‘ í•¨ìˆ˜
start_collabora_docker() {
    log_info "Collabora Online Docker í™•ì¸ ì¤‘..."

    # Docker daemon í™•ì¸
    if ! docker info > /dev/null 2>&1; then
        log_error "Dockerê°€ ì‹¤í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤."
        return 1
    fi

    # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ í™•ì¸
    local existing_container=$(docker ps -a --filter "name=collabora" --format "{{.Names}}" | head -1)

    if [[ -n "$existing_container" ]]; then
        local status=$(docker inspect --format="{{.State.Status}}" "$existing_container" 2>/dev/null || echo "unknown")

        if [[ "$status" == "running" ]]; then
            log_success "Collabora Docker ì´ë¯¸ ì‹¤í–‰ ì¤‘: $existing_container"
            return 0
        else
            log_info "ê¸°ì¡´ Collabora ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            docker start "$existing_container" > /dev/null 2>&1
            sleep 3
        fi
    else
        log_info "ìƒˆ Collabora ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
        docker run -d \
            --name collabora-unified \
            -p 9980:9980 \
            -e "aliasgroup1=http://host.docker.internal:3000" \
            -e "extra_params=--o:ssl.enable=false --o:ssl.termination=true --o:net.proto=IPv4" \
            -e "DONT_GEN_SSL_CERT=1" \
            --add-host host.docker.internal:host-gateway \
            collabora/code:23.05.4.2.1 > /dev/null 2>&1
    fi

    if check_service_health "Collabora" "http://localhost:9980/hosting/discovery" 20 2; then
        log_success "Collabora Online ì‹¤í–‰ë¨ (í¬íŠ¸ 9980)"
        return 0
    else
        log_error "Collabora Online ì‹œì‘ ì‹¤íŒ¨"
        return 1
    fi
}

# Rails ì‹œì‘ í•¨ìˆ˜
start_rails() {
    log_info "Rails ì„œë²„ ì‹œì‘ ì¤‘... (í¬íŠ¸ 3000)"

    # tmux ì„¸ì…˜ ìƒì„±
    tmux new-session -d -s excel-unified -n rails

    # Rails í™˜ê²½ ì„¤ì • ë° ì‹¤í–‰
    tmux send-keys -t excel-unified:rails "cd /Users/kevin/excel-unified/rails-app" C-m
    tmux send-keys -t excel-unified:rails "export RAILS_ENV=development" C-m
    tmux send-keys -t excel-unified:rails "export RAILS_MAX_THREADS=5" C-m
    tmux send-keys -t excel-unified:rails "rm -f tmp/pids/server.pid" C-m
    tmux send-keys -t excel-unified:rails "bin/dev" C-m

    # Rails ì‹œì‘ í™•ì¸
    if check_service_health "Rails" "http://localhost:3000/up" 30 2; then
        log_success "Rails ì„œë²„ ì‹¤í–‰ë¨ (í¬íŠ¸ 3000)"

        # Sidekiq ì‹œì‘ (Rails ì‹œì‘ í›„)
        tmux new-window -t excel-unified -n sidekiq
        tmux send-keys -t excel-unified:sidekiq "cd /Users/kevin/excel-unified/rails-app && bundle exec sidekiq" C-m
        log_success "Sidekiq ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‹œì‘ë¨"

        return 0
    else
        log_error "Rails ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
        return 1
    fi
}

# Python ì‹œì‘ í•¨ìˆ˜
start_python() {
    log_info "Python ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘... (í¬íŠ¸ 8000)"

    # í¬íŠ¸ í™•ì¸ ë° ì •ë¦¬
    if lsof -ti:8000 > /dev/null 2>&1; then
        kill -9 $(lsof -ti:8000) 2>/dev/null || true
        sleep 1
    fi

    # Python ì„œë¹„ìŠ¤ ì‹œì‘
    tmux new-window -t excel-unified -n python
    tmux send-keys -t excel-unified:python "cd /Users/kevin/excel-unified/python-service" C-m
    tmux send-keys -t excel-unified:python "source venv/bin/activate" C-m
    tmux send-keys -t excel-unified:python "export PYTHONPATH=/Users/kevin/excel-unified/python-service" C-m
    tmux send-keys -t excel-unified:python "uvicorn main:app --reload --host 0.0.0.0 --port 8000" C-m

    # Python ì„œë¹„ìŠ¤ í™•ì¸
    if check_service_health "Python" "http://localhost:8000/health" 45 2; then
        log_success "Python ì„œë¹„ìŠ¤ ì‹¤í–‰ë¨ (í¬íŠ¸ 8000)"
        return 0
    else
        log_error "Python ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
        # ë¡œê·¸ í™•ì¸ ëª…ë ¹ ì œê³µ
        log_error "ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”: tmux attach -t excel-unified:python"
        return 1
    fi
}

# ë³‘ë ¬ ì„œë¹„ìŠ¤ ì‹œì‘ í•¨ìˆ˜
start_services_parallel() {
    log_header "ì„œë¹„ìŠ¤ ë³‘ë ¬ ì‹œì‘"

    local pids=()
    local services=()

    # Rails ì‹œì‘
    (start_rails) &
    pids+=($!)
    services+=("Rails")

    # Python ì‹œì‘ (Railsì™€ ë™ì‹œì—)
    (start_python) &
    pids+=($!)
    services+=("Python")

    # Collabora ì‹œì‘ (ë…ë¦½ì )
    (start_collabora_docker) &
    pids+=($!)
    services+=("Collabora")

    # ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ëŒ€ê¸°
    local failed=false
    for i in "${!pids[@]}"; do
        if ! wait "${pids[$i]}"; then
            log_error "${services[$i]} ì‹œì‘ ì‹¤íŒ¨"
            failed=true
        fi
    done

    if [[ "$failed" == true ]]; then
        return 1
    fi

    return 0
}

# ì„œë¹„ìŠ¤ ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
show_service_status() {
    log_header "ì„œë¹„ìŠ¤ ìƒíƒœ"

    local services=(
        "Rails|http://localhost:3000/up|3000"
        "Python|http://localhost:8000/health|8000"
        "Collabora|http://localhost:9980/hosting/discovery|9980"
        "PostgreSQL|pg_isready|5432"
        "Redis|redis-cli ping|6379"
    )

    for service_info in "${services[@]}"; do
        IFS='|' read -r name check port <<< "$service_info"

        if [[ "$name" == "PostgreSQL" ]]; then
            if pg_isready -h localhost -p 5432 > /dev/null 2>&1; then
                echo -e "${GREEN}âœ… $name (í¬íŠ¸ $port)${NC}"
            else
                echo -e "${RED}âŒ $name (í¬íŠ¸ $port)${NC}"
            fi
        elif [[ "$name" == "Redis" ]]; then
            if redis-cli ping > /dev/null 2>&1; then
                echo -e "${GREEN}âœ… $name (í¬íŠ¸ $port)${NC}"
            else
                echo -e "${RED}âŒ $name (í¬íŠ¸ $port)${NC}"
            fi
        else
            if curl -s "$check" > /dev/null 2>&1; then
                echo -e "${GREEN}âœ… $name (í¬íŠ¸ $port)${NC}"
            else
                echo -e "${RED}âŒ $name (í¬íŠ¸ $port)${NC}"
            fi
        fi
    done
}

# ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
main() {
    log_header "Excel Unified í†µí•© ì‹œìŠ¤í…œ ì‹œì‘"
    echo ""

    # 1. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
    if [[ -z "$ONLY_SERVICE" || "$ONLY_SERVICE" == "all" ]]; then
        cleanup_processes
    fi

    # 2. í•„ìˆ˜ ì„œë¹„ìŠ¤ í™•ì¸
    if [[ -z "$ONLY_SERVICE" || "$ONLY_SERVICE" == "all" ]]; then
        log_header "í•„ìˆ˜ ì„œë¹„ìŠ¤ í™•ì¸"
        ensure_postgresql || exit 1
        ensure_redis || exit 1
    fi

    # 3. ì„œë¹„ìŠ¤ ì‹œì‘
    case "$ONLY_SERVICE" in
        "rails")
            start_rails || exit 1
            ;;
        "python")
            start_python || exit 1
            ;;
        "collabora"|"docker")
            start_collabora_docker || exit 1
            ;;
        *)
            if [[ "$PARALLEL" == true ]]; then
                start_services_parallel || exit 1
            else
                log_header "Docker ì„œë¹„ìŠ¤ ì‹œì‘"
                start_collabora_docker || log_warning "Collabora ì‹œì‘ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"

                log_header "ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ ì‹œì‘"
                start_rails || exit 1
                start_python || exit 1
            fi
            ;;
    esac

    # 4. ì™„ë£Œ ë©”ì‹œì§€
    END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))

    echo ""
    log_header "ğŸ‰ Excel Unified ì‹œìŠ¤í…œ ì‹œì‘ ì™„ë£Œ! (${DURATION}ì´ˆ)"
    echo ""

    # 5. ì„œë¹„ìŠ¤ ìƒíƒœ í‘œì‹œ
    show_service_status

    echo ""
    log_info "ì„œë¹„ìŠ¤ URL:"
    echo -e "  ${CYAN}ğŸ“ ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜: ${BOLD}http://localhost:3000${NC}"
    echo -e "  ${CYAN}ğŸ“ Excel AI: ${BOLD}http://localhost:3000/ai/excel${NC}"
    echo -e "  ${CYAN}ğŸ“ Python API ë¬¸ì„œ: ${BOLD}http://localhost:8000/docs${NC}"
    echo ""

    log_info "ìœ ìš©í•œ ëª…ë ¹ì–´:"
    echo -e "  ${YELLOW}tmux attach -t excel-unified${NC}         # ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸"
    echo -e "  ${YELLOW}tmux list-windows -t excel-unified${NC}   # ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ëª©ë¡"
    echo -e "  ${YELLOW}./stop-all${NC}                          # ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ"
    echo ""

    # 6. ë¸Œë¼ìš°ì € ì—´ê¸°
    if [[ "$OPEN_BROWSER" == true && -z "$ONLY_SERVICE" ]]; then
        sleep 2  # ì„œë¹„ìŠ¤ê°€ ì™„ì „íˆ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        log_info "ë¸Œë¼ìš°ì €ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—´ê¸°..."
        if command -v open &> /dev/null; then
            open "http://localhost:3000/ai/excel"
        elif command -v xdg-open &> /dev/null; then
            xdg-open "http://localhost:3000/ai/excel"
        fi
    fi
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"
